#!/usr/bin/env python3
"""
ä½¿ç”¨ pycookiecheat åº“å¯¼å‡º Chrome æ‰€æœ‰ cookies
è¾“å‡ºåˆ° stdoutï¼Œå¯ä»¥ä½¿ç”¨é‡å®šå‘ä¿å­˜åˆ°æ–‡ä»¶

ç”¨æ³•:
    python3 export_cookies_pycookiecheat.py > cookies.txt
"""

import sys
import os


def export_all_cookies():
    """å¯¼å‡ºæ‰€æœ‰ Chrome cookies åˆ° stdout"""

    try:
        import pycookiecheat
    except ImportError:
        print("âŒ pycookiecheat æœªå®‰è£…", file=sys.stderr)
        print("\nè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…:", file=sys.stderr)
        print("  pip3 install pycookiecheat", file=sys.stderr)
        return False

    try:
        import sqlite3
        import shutil
        import tempfile
        from pathlib import Path
        from datetime import datetime, timedelta

        # èŽ·å– Chrome cookies æ•°æ®åº“è·¯å¾„
        if sys.platform == "darwin":  # macOS
            cookies_db = Path.home() / "Library/Application Support/Google/Chrome/Default/Cookies"
        elif sys.platform == "win32":  # Windows
            cookies_db = Path(os.getenv("LOCALAPPDATA")) / "Google/Chrome/User Data/Default/Network/Cookies"
        elif sys.platform.startswith("linux"):  # Linux
            cookies_db = Path.home() / ".config/google-chrome/Default/Cookies"
        else:
            print(f"âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: {sys.platform}", file=sys.stderr)
            return False

        if not cookies_db.exists():
            print(f"âŒ æ‰¾ä¸åˆ° Chrome cookies æ–‡ä»¶: {cookies_db}", file=sys.stderr)
            return False

        # å¤åˆ¶æ•°æ®åº“åˆ°ä¸´æ—¶æ–‡ä»¶
        temp_db = tempfile.NamedTemporaryFile(delete=False, suffix='.db')
        temp_db.close()

        try:
            shutil.copy2(cookies_db, temp_db.name)
            conn = sqlite3.connect(temp_db.name)
            cursor = conn.cursor()

            # èŽ·å–æ‰€æœ‰ cookies
            query = """
                SELECT host_key, name, value, path, expires_utc, is_secure, is_httponly, encrypted_value
                FROM cookies
                ORDER BY host_key, name
            """
            cursor.execute(query)
            all_cookies = cursor.fetchall()
            conn.close()

            if not all_cookies:
                print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• cookies", file=sys.stderr)
                return False

            print(f"ðŸ” æ‰¾åˆ° {len(all_cookies)} ä¸ª cookies", file=sys.stderr)

            # è§£å¯† cookies
            print(f"ðŸ”“ æ­£åœ¨è§£å¯†...", file=sys.stderr)

            # è¾“å‡º Netscape æ ¼å¼çš„å¤´éƒ¨
            print("# Netscape HTTP Cookie File")
            print("# This file was generated by pycookiecheat")
            print("# Edit at your own risk.")
            print()

            # ä½¿ç”¨ pycookiecheat è§£å¯†
            # ç”±äºŽ pycookiecheat æ˜¯æŒ‰åŸŸåå¯¼å‡ºçš„ï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†æ‰€æœ‰åŸŸå
            domains = set()
            for cookie in all_cookies:
                host_key = cookie[0]
                # æå–åŸŸåï¼ˆåŽ»æŽ‰å‰å¯¼çš„ç‚¹ï¼‰
                domain = host_key.lstrip('.')
                if domain:
                    domains.add(domain)

            # å¯¹æ¯ä¸ªåŸŸåå¯¼å‡º cookies
            exported_count = 0
            processed_domains = set()

            for domain in sorted(domains):
                if domain in processed_domains:
                    continue

                try:
                    cookies = pycookiecheat.chrome_cookies(domain)
                    if cookies:
                        processed_domains.add(domain)
                        for name, value in cookies.items():
                            # ä»ŽåŽŸå§‹æ•°æ®ä¸­æŸ¥æ‰¾åŒ¹é…çš„ cookie ä»¥èŽ·å–å®Œæ•´ä¿¡æ¯
                            cookie_data = None
                            for c in all_cookies:
                                if c[1] == name and domain in c[0]:
                                    cookie_data = c
                                    break

                            if cookie_data:
                                host_key, _, _, path, expires_utc, is_secure, is_httponly, _ = cookie_data

                                # è½¬æ¢è¿‡æœŸæ—¶é—´
                                if expires_utc:
                                    chrome_epoch = datetime(1601, 1, 1)
                                    unix_epoch = datetime(1970, 1, 1)
                                    delta = (unix_epoch - chrome_epoch).total_seconds()
                                    expires = int(expires_utc / 1000000 - delta)
                                else:
                                    expires = int((datetime.now() + timedelta(days=365*10)).timestamp())

                                flag = "TRUE" if host_key.startswith('.') else "FALSE"
                                path = path or "/"
                                secure = "TRUE" if is_secure else "FALSE"

                                print(f"{host_key}\t{flag}\t{path}\t{secure}\t{expires}\t{name}\t{value}")
                                exported_count += 1
                except:
                    # æŸäº›åŸŸåå¯èƒ½æ— æ³•å¯¼å‡ºï¼Œè·³è¿‡
                    pass

            print(f"âœ… æˆåŠŸå¯¼å‡º {exported_count} ä¸ª cookies", file=sys.stderr)
            return True

        finally:
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try:
                os.unlink(temp_db.name)
            except:
                pass

    except Exception as e:
        print(f"âŒ å¯¼å‡ºå¤±è´¥: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        return False


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] in ['-h', '--help', 'help']:
        print("ç”¨æ³•: python3 export_cookies_pycookiecheat.py > cookies.txt", file=sys.stderr)
        print("\nå¯¼å‡ºæ‰€æœ‰ Chrome cookies åˆ° stdout", file=sys.stderr)
        print("ä½¿ç”¨é‡å®šå‘ (>) ä¿å­˜åˆ°æ–‡ä»¶", file=sys.stderr)
        print("\nç¤ºä¾‹:", file=sys.stderr)
        print("  python3 export_cookies_pycookiecheat.py > cookies.txt", file=sys.stderr)
        print("  python3 export_cookies_pycookiecheat.py > app/cookies.txt", file=sys.stderr)
        sys.exit(0)

    success = export_all_cookies()
    sys.exit(0 if success else 1)
