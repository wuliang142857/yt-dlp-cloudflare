#!/usr/bin/env python3
"""
Firefox Cookies å¯¼å‡ºå·¥å…· (æ— åŠ å¯†ï¼Œ100% æˆåŠŸç‡)
Firefox çš„ cookies å­˜å‚¨åœ¨ SQLite æ•°æ®åº“ä¸­ï¼Œä¸åŠ å¯†ï¼Œéå¸¸å®¹æ˜“è¯»å–

ç”¨æ³•:
    python3 export_cookies_firefox.py > cookies.txt
"""

import sys
import os
import sqlite3
import shutil
import tempfile
from pathlib import Path
from datetime import datetime


def find_firefox_profile():
    """æŸ¥æ‰¾ Firefox é…ç½®æ–‡ä»¶ç›®å½•"""

    if sys.platform == "darwin":  # macOS
        base_path = Path.home() / "Library/Application Support/Firefox/Profiles"
    elif sys.platform == "win32":  # Windows
        base_path = Path(os.getenv("APPDATA")) / "Mozilla/Firefox/Profiles"
    else:  # Linux
        base_path = Path.home() / ".mozilla/firefox"

    if not base_path.exists():
        return None

    # æŸ¥æ‰¾é»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸åŒ…å« .default æˆ– .default-releaseï¼‰
    profiles = []
    for profile_dir in base_path.iterdir():
        if profile_dir.is_dir():
            cookies_db = profile_dir / "cookies.sqlite"
            if cookies_db.exists():
                profiles.append(cookies_db)

    if not profiles:
        return None

    # è¿”å›æœ€æ–°ä¿®æ”¹çš„é…ç½®æ–‡ä»¶
    return max(profiles, key=lambda p: p.stat().st_mtime)


def export_firefox_cookies():
    """å¯¼å‡º Firefox cookies"""

    # æŸ¥æ‰¾ Firefox cookies æ•°æ®åº“
    cookies_db = find_firefox_profile()

    if not cookies_db:
        print("âŒ æ‰¾ä¸åˆ° Firefox cookies æ–‡ä»¶", file=sys.stderr)
        print("\nå¯èƒ½çš„åŸå› :", file=sys.stderr)
        print("  1. Firefox æœªå®‰è£…", file=sys.stderr)
        print("  2. Firefox ä»æœªä½¿ç”¨è¿‡ï¼ˆæ²¡æœ‰è®¿é—®è¿‡ä»»ä½•ç½‘ç«™ï¼‰", file=sys.stderr)
        print("\né¢„æœŸè·¯å¾„:", file=sys.stderr)
        if sys.platform.startswith("linux"):
            print("  ~/.mozilla/firefox/*/cookies.sqlite", file=sys.stderr)
        elif sys.platform == "darwin":
            print("  ~/Library/Application Support/Firefox/Profiles/*/cookies.sqlite", file=sys.stderr)
        return False

    print(f"ğŸ“‚ ä½¿ç”¨ Firefox cookies æ–‡ä»¶: {cookies_db}", file=sys.stderr)

    # åˆ›å»ºä¸´æ—¶å‰¯æœ¬ï¼ˆé¿å…æ•°æ®åº“é”å®šé—®é¢˜ï¼‰
    temp_db = tempfile.NamedTemporaryFile(delete=False, suffix='.sqlite')
    temp_db.close()

    try:
        shutil.copy2(cookies_db, temp_db.name)

        # è¿æ¥åˆ°æ•°æ®åº“
        conn = sqlite3.connect(temp_db.name)
        cursor = conn.cursor()

        # æŸ¥è¯¢æ‰€æœ‰ cookies
        # Firefox cookies è¡¨ç»“æ„ï¼š
        # name, value, host, path, expiry, isSecure, isHttpOnly
        query = """
            SELECT host, name, value, path, expiry, isSecure
            FROM moz_cookies
            ORDER BY host, name
        """

        cursor.execute(query)
        cookies = cursor.fetchall()
        conn.close()

        if not cookies:
            print("âŒ Firefox cookies æ•°æ®åº“ä¸ºç©º", file=sys.stderr)
            print("   è¯·å…ˆä½¿ç”¨ Firefox è®¿é—®ä¸€äº›ç½‘ç«™", file=sys.stderr)
            return False

        print(f"âœ… æ‰¾åˆ° {len(cookies)} ä¸ª cookies", file=sys.stderr)

        # è¾“å‡º Netscape æ ¼å¼
        print("# Netscape HTTP Cookie File")
        print("# This file was generated by export_cookies_firefox.py")
        print("# Firefox cookies are NOT encrypted - 100% success rate!")
        print("# Edit at your own risk.")
        print()

        exported_count = 0

        for cookie in cookies:
            host, name, value, path, expiry, is_secure = cookie

            # è·³è¿‡ç©ºå€¼
            if not host or not name or value is None:
                continue

            # Netscape æ ¼å¼
            # domain flag path secure expiry name value

            # åŸŸåæ ‡å¿—
            flag = "TRUE" if host.startswith('.') else "FALSE"

            # è·¯å¾„
            path = path or "/"

            # å®‰å…¨æ ‡å¿—
            secure = "TRUE" if is_secure else "FALSE"

            # è¿‡æœŸæ—¶é—´ï¼ˆFirefox ä½¿ç”¨ Unix æ—¶é—´æˆ³ï¼Œå•ä½æ˜¯ç§’ï¼‰
            if expiry:
                expires = int(expiry)
            else:
                # ä¼šè¯ cookieï¼Œè®¾ç½®ä¸º 10 å¹´å
                expires = int(datetime.now().timestamp()) + 365*24*3600*10

            print(f"{host}\t{flag}\t{path}\t{secure}\t{expires}\t{name}\t{value}")
            exported_count += 1

        print(f"âœ… æˆåŠŸå¯¼å‡º {exported_count} ä¸ª cookies", file=sys.stderr)
        return True

    except Exception as e:
        print(f"âŒ å¯¼å‡ºå¤±è´¥: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc(file=sys.stderr)
        return False
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        try:
            os.unlink(temp_db.name)
        except:
            pass


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] in ['-h', '--help', 'help']:
        print("=" * 60, file=sys.stderr)
        print("Firefox Cookies å¯¼å‡ºå·¥å…·", file=sys.stderr)
        print("=" * 60, file=sys.stderr)
        print("\nç‰¹ç‚¹:", file=sys.stderr)
        print("  âœ… Firefox cookies ä¸åŠ å¯†", file=sys.stderr)
        print("  âœ… 100% æˆåŠŸç‡", file=sys.stderr)
        print("  âœ… æ— éœ€é¢å¤–ä¾èµ–", file=sys.stderr)
        print("  âœ… é€‚ç”¨äºæ‰€æœ‰ Firefox ç‰ˆæœ¬", file=sys.stderr)
        print("\nç”¨æ³•:", file=sys.stderr)
        print("  python3 export_cookies_firefox.py > cookies.txt", file=sys.stderr)
        print("\nå»ºè®®:", file=sys.stderr)
        print("  1. å…ˆå…³é—­ Firefox (å¯é€‰ï¼Œä½†æ¨è):", file=sys.stderr)
        print("     pkill firefox", file=sys.stderr)
        print("  2. å¯¼å‡º cookies:", file=sys.stderr)
        print("     python3 export_cookies_firefox.py > cookies.txt", file=sys.stderr)
        print("  3. éªŒè¯ç»“æœ:", file=sys.stderr)
        print("     grep -v '^#' cookies.txt | wc -l", file=sys.stderr)
        print("=" * 60, file=sys.stderr)
        sys.exit(0)

    success = export_firefox_cookies()
    sys.exit(0 if success else 1)
